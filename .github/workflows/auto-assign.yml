name: Auto Assign Project and Fields
on:
  issues:
    types: [opened]

jobs:
  assign:
    runs-on: ubuntu-latest
    steps:
      - name: Add new issues to Petlibro project
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name.toLowerCase());

            const projectId = "PVT_kwHOAclbns4AqfIH"; // Petlibro Project ID

            // Only process your templates
            const allowedLabels = ["bug", "feature request", "new device"];
            if (!labels.some(l => allowedLabels.includes(l))) {
              console.log("Skipping — issue does not match your templates.");
              return;
            }

            // ✅ Check if the project exists
            try {
              const projectCheck = await github.graphql(`
                query($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      id
                      title
                    }
                  }
                }
              `, { projectId });

              if (!projectCheck.node) {
                console.log(`❌ Project with ID ${projectId} not found.`);
                return;
              }

              console.log(`✅ Project found: ${projectCheck.node.title}`);
            } catch (error) {
              console.error("Error checking project:", error);
              return;
            }

            // 1️⃣ Add issue to the project
            let itemId;
            try {
              const addIssue = await github.graphql(`
                mutation($projectId: ID!, $issueId: ID!) {
                  addProjectV2ItemById(input: {projectId: $projectId, contentId: $issueId}) {
                    item { id }
                  }
                }
              `, { projectId, issueId: issue.node_id });

              itemId = addIssue.addProjectV2ItemById.item.id;
              console.log(`✅ Added issue #${issue.number} to Petlibro project.`);
            } catch (error) {
              console.error("Error adding issue to project:", error);
              return;
            }

            // 2️⃣ Set Priority
            const priorityFieldId = "PVTSSF_lAHOAclbns4AqfIHzghudTQ";
            const priorityOptions = {
              "Critical": "79628723",
              "High": "0a877460",
              "Medium": "da944a9c",
              "Low": "0b6337eb",
              "Deferred": "9d531ad0",
              "Completed": "20ffdcc8"
            };

            let priorityValue = "Medium"; // default
            if (labels.includes("bug")) priorityValue = "High";
            else if (labels.includes("feature request")) priorityValue = "Medium";
            else if (labels.includes("new device")) priorityValue = "Low";

            console.log(`Setting Priority to ${priorityValue} (ID: ${priorityOptions[priorityValue]})`);
            try {
              await github.graphql(`
                mutation($itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: { singleSelectOptionId: $optionId }
                  }) {
                    item { id }
                  }
                }
              `, { itemId, fieldId: priorityFieldId, optionId: priorityOptions[priorityValue] });
              console.log(`✅ Set Priority to ${priorityValue}`);
            } catch (error) {
              console.error("Error setting Priority:", error);
            }

            // 3️⃣ Set Status
            const statusFieldId = "PVTSSF_lAHOAclbns4AqfIHzghucgA";
            const statusOptions = {
              "To triage": "f971fb55",
              "Pending": "f75ad846",
              "Ready": "856cdede",
              "In progress": "47fc9ee4",
              "In review": "5ef0dc97",
              "Deferred": "e0243c67",
              "Done": "98236657"
            };

            let statusValue = "To triage"; // default
            if (labels.includes("bug")) statusValue = "Pending";
            else if (labels.includes("feature request")) statusValue = "To triage";
            else if (labels.includes("new device")) statusValue = "Ready";

            console.log(`Setting Status to ${statusValue} (ID: ${statusOptions[statusValue]})`);
            try {
              await github.graphql(`
                mutation($itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: { singleSelectOptionId: $optionId }
                  }) {
                    item { id }
                  }
                }
              `, { itemId, fieldId: statusFieldId, optionId: statusOptions[statusValue] });
              console.log(`✅ Set Status to ${statusValue}`);
            } catch (error) {
              console.error("Error setting Status:", error);
            }
