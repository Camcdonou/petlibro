name: Auto Assign Project and Fields
on:
  issues:
    types: [opened]

jobs:
  assign:
    runs-on: ubuntu-latest
    steps:
      - name: Add new issues to Petlibro project
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);

            const projectId = "PVT_kwHOAclbns4AqfIH"; // Petlibro Project ID

            // Only process your templates
            const allowedLabels = ["Bug", "Feature Request", "New Device"];
            if (!labels.some(l => allowedLabels.includes(l))) {
              console.log("Skipping — issue does not match your templates.");
              return;
            }

            // 1️⃣ Add issue to the project
            const addIssue = await github.graphql(`
              mutation($projectId: ID!, $issueId: ID!) {
                addProjectV2ItemById(input: {projectId: $projectId, contentId: $issueId}) {
                  item { id }
                }
              }
            `, {
              projectId,
              issueId: issue.node_id
            });

            const itemId = addIssue.addProjectV2ItemById.item.id;
            console.log(`✅ Added issue #${issue.number} to Petlibro project.`);

            // 2️⃣ Set Priority (Single Select)
            const priorityFieldId = "PVTSSF_lAHOAclbns4AqfIHzghudTQ"; // Priority field ID
            const priorityOptions = {
              "Critical": "79628723",
              "High": "0a877460",
              "Medium": "da944a9c",
              "Low": "0b6337eb",
              "Deferred": "9d531ad0",
              "Completed": "20ffdcc8"
            };

            let priorityValue = "Medium";
            if (labels.includes("Bug")) priorityValue = "High";
            else if (labels.includes("Feature Request")) priorityValue = "Medium";
            else if (labels.includes("New Device")) priorityValue = "Low";

            await github.graphql(`
              mutation($itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  itemId: $itemId,
                  fieldId: $fieldId,
                  value: { singleSelectOptionId: $optionId }
                }) {
                  item { id }
                }
              }
            `, {
              itemId,
              fieldId: priorityFieldId,
              optionId: priorityOptions[priorityValue]
            });
            console.log(`✅ Set Priority to ${priorityValue}`);

            // 3️⃣ Set Status dynamically (Single Select)
            const statusFieldId = "PVTSSF_lAHOAclbns4AqfIHzghucgA"; // Status field ID
            const statusOptions = {
              "To triage": "f971fb55",
              "Pending": "f75ad846",
              "Ready": "856cdede",
              "In progress": "47fc9ee4",
              "In review": "5ef0dc97",
              "Deferred": "e0243c67",
              "Done": "98236657"
            };

            let statusValue = "To triage"; // default
            if (labels.includes("Bug")) statusValue = "Pending";
            else if (labels.includes("Feature Request")) statusValue = "To triage";
            else if (labels.includes("New Device")) statusValue = "Ready";

            await github.graphql(`
              mutation($itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  itemId: $itemId,
                  fieldId: $fieldId,
                  value: { singleSelectOptionId: $optionId }
                }) {
                  item { id }
                }
              }
            `, {
              itemId,
              fieldId: statusFieldId,
              optionId: statusOptions[statusValue]
            });
            console.log(`✅ Set Status to ${statusValue}`);

            // 4️⃣ Optional: Set Start Date (if you have a field)
            // const startDateFieldId = "YOUR_START_DATE_FIELD_ID";
            // const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD
            // await github.graphql(`
            //   mutation($itemId: ID!, $fieldId: ID!, $value: String!) {
            //     updateProjectV2ItemFieldValue(input: {
            //       itemId: $itemId,
            //       fieldId: $fieldId,
            //       value: { date: $value }
            //     }) {
            //       item { id }
            //     }
            //   }
            // `, { itemId, fieldId: startDateFieldId, value: today });
            // console.log(`✅ Set Start Date to ${today}`);
